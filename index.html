<html>
    <head lang="en">
        <title>Go Tools</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="utf-8"/>
        <script src="https://cdn.jsdelivr.net/gh/golang/go@go1.24.6/lib/wasm/wasm_exec.js"></script>
        <script>
            const go = new Go();
            const loadGo = WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject)
        </script>
        <style>
            body, .column {
                background-color: linen;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .row {
                display: flex;
                flex-direction: row;
                justify-content: center;
                align-items: center;
            }
            .btn-space {
                margin-top: 8px;
            }
            .wide {
                width: 100%;
            }
            .split {
                display: flex;
                flex-direction: row;
                justify-content: space-around;
            }
            .failure {
                background: rgb(255, 100, 100);
            }
            :popover-open {
                position: absolute;
                inset: unset;
                left: 5px;
                bottom: 5px;
            }
        </style>
    </head>
    <body>
        <h1>Go Tools</h1>
        <p>Transforms written in Golang using WASM.</p>

        <div class="row">
            <div class="column">
                <textarea id="transform-text" rows="24" cols="70">{"foo":"bar"}</textarea>
                <div>
                    <span>Examples:</span>
                    <button id="ex-json">JSON</button>
                    <button id="ex-html">HTML</button>
                    <button id="ex-url">URL</button>
                    <button id="ex-bytes">Bytes</button>
                    <button id="gen-uuidv7">UUIDv7</button>
                </div>
            </div>
            <div class="column">
                <button id="pretty" disabled>JSON Pretty</button>
                <button id="compress" disabled>JSON Compress</button>

                <div class="btn-space"></div>
                <button id="escape">JSON Escape</button>
                <button id="unescape">JSON Unescape</button>

                <div class="btn-space"></div>
                <button id="b64-encode">Base64 Encode</button>
                <button id="b64-decode">Base64 Decode</button>

                <div class="btn-space"></div>
                <button id="url-encode">URL Encode</button>
                <button id="url-decode">URL Decode</button>

                <div class="btn-space"></div>
                <button id="html-escape">HTML Escape</button>
                <button id="html-unescape">HTML Unescape</button>

                <div class="btn-space"></div>
                <button id="php-serialize-encode">PHP Serialize</button>
                <button id="php-serialize-decode">PHP Unserialize</button>

                <div class="btn-space"></div>
                <button id="string-byte">String to Bytes</button>
                <button id="byte-string">Bytes to String</button>

                <div class="btn-space"></div>
                <span>
                    <button id="uuid-timestamp">UUIDv7 Timestamp</button>
                </span>
                 <dialog id="timestamp-dialog">
                    <div>
                        Timezone:
                        <input id="uuid-timestamp-timezone" type="text" placeholder="(e.g., Local, UTC)" value='Local' />
                    </div>
                    <div>
                        Fmt (Uses <a href="https://golang.org/pkg/time/#pkg-constants" target="_blank">Go standards</a>):
                        <input id="uuid-timestamp-format" type="text" placeholder="(e.g., RFC1123, RFC3339, Datetime)" value='RFC1123' />
                    </div>

                    <div class="btn-space"></div>
                    <input id="uuid-timestamp-result" class="wide" readonly/>

                    <div class="btn-space"></div>
                    <div class="split">
                        <button id="uuid-timestamp-parse">Parse</button>
                        <button id="close-dialog">Close</button>
                    </div>
                </dialog>
            </div>
        </div>

        <style>#forkongithub a{background:#000;color:#fff;text-decoration:none;font-family:arial,sans-serif;text-align:center;font-weight:bold;padding:5px 40px;font-size:1rem;line-height:2rem;position:relative;transition:0.5s;}#forkongithub a:hover{background:#c11;color:#fff;}#forkongithub a::before,#forkongithub a::after{content:"";width:100%;display:block;position:absolute;top:1px;left:0;height:1px;background:#fff;}#forkongithub a::after{bottom:1px;top:auto;}@media screen and (min-width:1000px){#forkongithub{position:fixed;display:block;top:0;right:0;width:200px;overflow:hidden;height:200px;z-index:9999;}#forkongithub a{width:200px;position:absolute;top:60px;right:-60px;transform:rotate(45deg);-webkit-transform:rotate(45deg);-ms-transform:rotate(45deg);-moz-transform:rotate(45deg);-o-transform:rotate(45deg);box-shadow:4px 4px 10px rgba(0,0,0,0.8);}}</style>
        <span id="forkongithub"><a href="https://github.com/mvndaai/go_wasm_tools">Fork me on GitHub</a></span>
        <script>
            const btns = document.querySelectorAll('button');
            loadGo.then((result) => {
                go.run(result.instance);
                document.querySelectorAll('button').forEach(btn => btn.disabled = false);
            });


            // https://mdn.github.io/dom-examples/popover-api/toast-popovers/
            function makeErrorToast(msg) {
                // Create an element and make it into a popover
                const popover = document.createElement("article");
                popover.popover = "manual";
                popover.classList.add("toast");
                popover.classList.add("newest");
                popover.classList.add("failure");

                // Give the toast its text content, and add it to the DOM
                popover.textContent = msg;
                document.body.appendChild(popover);

                // Show the popover
                popover.showPopover();

                // Remove the toast again after 4 seconds
                setTimeout(() => {
                    popover.hidePopover();
                    popover.remove();
                }, 4000);

                // When a new toast appears, run the movetoastsUp() function
                popover.addEventListener("toggle", (event) => {
                    if (event.newState === "open") {
                        moveToastsUp();
                    }
                });
            }
            function moveToastsUp() {
                const toasts = document.querySelectorAll(".toast");
                toasts.forEach((toast) => {
                    // If the toast is the one that has just appeared, we don't want it to move up.
                    if (toast.classList.contains("newest")) {
                        toast.style.bottom = `5px`;
                        toast.classList.remove("newest");
                    } else {
                        // Move up all the other toasts by 50px to make way for the new one
                        const prevValue = toast.style.bottom.replace("px", "");
                        const newValue = parseInt(prevValue) + 50;
                        toast.style.bottom = `${newValue}px`;
                    }
                });
            }


            function addOnClick(button, goFn, input, output) {
                button.onclick = (e) => {
                    e.preventDefault();

                    let inStr = input.value;
                    if (typeof input === 'function') {
                        inStr = input();
                    }
                    const k = JSON.parse(golang[goFn](inStr));
                    console.log(`Response from Go ${goFn}(${inStr})`, k);
                    if (k.error) {
                        console.error(k.error)
                        makeErrorToast(k.error);
                        return;
                    }
                    output.value = k.response;
                }
            }

            const transformText = document.querySelector('#transform-text');
            transformText.focus();

            const pretty = document.querySelector('#pretty');
            const compress = document.querySelector('#compress');
            addOnClick(pretty, 'prettyJSON', transformText, transformText);
            addOnClick(compress, 'compressJSON', transformText, transformText);

            const escape = document.querySelector('#escape');
            const unescape = document.querySelector('#unescape');
            addOnClick(escape, 'escapeJSON', transformText, transformText);
            addOnClick(unescape, 'unescapeJSON', transformText, transformText);

            const htmlEscape = document.querySelector('#html-escape');
            const htmlEnescape = document.querySelector('#html-unescape');
            addOnClick(htmlEscape, 'escapeHTML', transformText, transformText);
            addOnClick(htmlEnescape, 'unescapeHTML', transformText, transformText);

            const b64Encode = document.querySelector('#b64-encode');
            const b64Decode = document.querySelector('#b64-decode');
            addOnClick(b64Encode, 'bEncode', transformText, transformText);
            addOnClick(b64Decode, 'bDecode', transformText, transformText);

            const urlEncode = document.querySelector('#url-encode');
            const urlDecode = document.querySelector('#url-decode');
            addOnClick(urlEncode, 'urlEncode', transformText, transformText);
            addOnClick(urlDecode, 'urlDecode', transformText, transformText);

            const bytesString = document.querySelector('#byte-string');
            const stringBytes = document.querySelector('#string-byte');
            addOnClick(bytesString, 'bytesToString', transformText, transformText);
            addOnClick(stringBytes, 'stringToBytes', transformText, transformText);

            const phpEncode = document.querySelector('#php-serialize-encode');
            const phpDecode = document.querySelector('#php-serialize-decode');
            addOnClick(phpEncode, 'phpSerializeEncode', transformText, transformText);
            addOnClick(phpDecode, 'phpSerializeDecode', transformText, transformText);

            const uuidDialog = document.querySelector('#timestamp-dialog');
            document.querySelector('#uuid-timestamp').onclick = () => {
                uuidTimestampParse.click(); // Trigger the parse button when showing the dialog
                uuidDialog.showModal();
            };
            document.querySelector('#close-dialog').onclick = () => uuidDialog.close();

            const uuidTimestamp = document.querySelector('#uuid-timestamp');
            const timezoneInput = document.querySelector('#uuid-timestamp-timezone');
            const timeFormatInput = document.querySelector('#uuid-timestamp-format');
            const uuidTimestampResult = document.querySelector('#uuid-timestamp-result');
            const uuidTimestampParse = document.querySelector('#uuid-timestamp-parse');
            function uuidTimestampInput () {
                return [transformText.value, timezoneInput.value, timeFormatInput.value].join(' ');
            }
            addOnClick(uuidTimestampParse, 'timestampUUIDv7', uuidTimestampInput, uuidTimestampResult);


            // Example text
            examples = [
                {
                    selector: '#ex-html',
                    text: () => '<input/>'
                },
                {
                    selector: '#ex-json',
                    text: () =>'{"foo":"bar"}'
                },
                {
                    selector: '#ex-bytes',
                    text: () => '[72 101 108 108 111 32 87 111 114 108 100]'
                },
                {
                    selector: '#ex-url',
                    text: () => 'https://example.com/path?query=123&bool=true'
                },
                {
                    selector: '#gen-uuidv7',
                    text: () => JSON.parse(golang['genUUIDv7']()).response
                }
            ]
            for (const ex of examples) {
                document.querySelector(ex.selector).onclick = (e) => {
                    e.preventDefault();
                    transformText.value = ex.text();
                }
            }
        </script>
    </body>
</html>
